from django.db import models
from django.contrib.contenttypes.models import ContentType
from django.contrib.contenttypes.fields import GenericForeignKey
from django.core.validators import MinValueValidator, MaxValueValidator
from django.utils import timezone
import uuid

class AnalysisResult(models.Model):
    """
    Class which represents the result of an detection analysis on a userâ€™s submission.
    Contains common fields shared across different analysis types.

    :author: Siyabonga Madondo, Ethan Ngwetjana, Lindokuhle Mdlalose
    :version: 22/08/2025
    """ 
    # Analysis status choices.
    class Status(models.TextChoices):
        PENDING = "PENDING", "Pending"
        PROCESSING = "PROCESSING", "Processing"
        COMPLETED = "COMPLETED", "Completed"
        FAILED = "FAILED", 'Failed'

    # Detection result choices.
    class DetectionResult(models.TextChoices):
        AI_GENERATED = "AI_GENERATED", "AI Generated"
        HUMAN_WRITTEN = "HUMAN_WRITTEN", "Human Written"
        UNCERTAIN = "UNCERTAIN", "Uncertain"

    # Core fields for the analysis result.
    id = models.UUIDField(
        primary_key=True,
        default=uuid.uuid4,
        editable=False,
        help_text="Unique identifier for the feedback."
    )
    status = models.CharField(
        max_length=20,
        choices=Status.choices,
        default=Status.PENDING,
        help_text="Current status of the analysis."
    )

    # Generic relation to any submission type.
    content_type = models.ForeignKey(ContentType, on_delete=models.CASCADE)
    object_id = models.UUIDField()
    submission = GenericForeignKey("content_type", "object_id")

    # Fields for detection results.
    detection_result = models.CharField(
        max_length=20,
        choices=DetectionResult.choices,
        null=True,
        blank=True,
        help_text="Final decision on whether content was generated by AI."
    )
    probability = models.FloatField(
        null=True,
        blank=True,
        validators=[MinValueValidator(0.0), MaxValueValidator(1.0)],
        help_text="Probability that content is AI-generated (0.0 to 1.0)."
    ) 
    confidence = models.FloatField(
        default=0.0,
        help_text="Model confidence in the prediction (0.0 - 1.0)"
    )

    # Fields for processing information.
    created_at = models.DateTimeField(
        auto_now_add=True,
        help_text="Timestamp when analysis started."
    )
    completed_at = models.DateTimeField(
        null=True,
        blank=True,
        help_text="Timestamp when analysis was completed."
    )
    processing_time_ms = models.PositiveIntegerField(
        null=True,
        blank=True,
        help_text="Time taken to process the analysis in milliseconds."
    )

    # Defining Metadata for the analysis result.
    class Meta:
        abstract = True
        ordering = ["-created_at"]
        indexes = [
            models.Index(fields=["content_type", "object_id"]),
            models.Index(fields=["status"]),
            models.Index(fields=["detection_result"]),
            models.Index(fields=["created_at"]),
        ]

    def __str__(self) -> str:
        """
        Returns a string representation of this analysis result.
        """
        return f"Analysis {self.id} | {self.status} | {self.detection_result}"
    
    @property
    def is_completed(self) -> bool:
        """
        Checks if analysis is complete.
        """
        return self.status == self.Status.COMPLETED
    
    @property
    def is_pending(self) -> bool:
        """
        Checks if analysis is pending.
        """
        return self.status == self.Status.PENDING
    
    @property
    def has_failed(self) -> bool:
        """
        Checks if analysis has failed.
        """
        return self.status == self.Status.FAILED
    
    def mark_as_processing(self) -> None:
        """
        Mark analysis as currently processing.
        """
        self.status = self.Status.PROCESSING
        self.save(update_fields=["status"])

    def mark_as_completed(self, detection_result, confidence_score, probability = None, reason = None) -> None:
        """
        Mark analysis as completed.
        """
        self.status = self.Status.COMPLETED
        self.detection_result = detection_result
        self.confidence = confidence_score
        self.probability = probability
        self.completed_at = timezone.now()
        self.calculate_processing_time()
        self.save(update_fields=["status", "detection_result", 
                                 "confidence_score", "probability", "reason", "completed_at", "processing_time_ms"])
        
    def mark_as_failed(self) -> None:
        """
        Mark analysis as failed.
        """
        self.status = self.Status.FAILED
        self.completed_at = timezone.now()
        self.calculate_processing_time()
        self.save(update_fields=["status", "completed_at", "processing_time_ms"])
    
    def calculate_processing_time(self) -> None:
        """
        Calculate and set the processing time in milliseconds.
        """
        if self.created_at and self.completed_at:
            time_diff = self.completed_at - self.created_at
            self.processing_time_ms = int(time_diff.total_seconds() * 1000)